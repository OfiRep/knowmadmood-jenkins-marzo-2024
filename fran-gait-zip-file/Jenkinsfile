@Library('knowmadmood-shared-library')

import main.groovy.com.knowmadmood.ejb.KnowMadMoodEJB

def decodeOriginFile = ""
def decodeDestinationFile = ""
def decodeCpuCores = ""
def decodeCompressType = ""

pipeline {
    agent { 
        label 'minion2'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '7', daysToKeepStr: '10'))
        timestamps()
    }
    
    parameters {
        choice (name: 'PARAMETERS_IN_BASE64', choices: ['No', 'Yes'], description: 'Indicación si los parámetros vienen en Base64')
        string (name: 'ORIGIN_FILE', defaultValue: '/home/jenkins/myfile', description: 'El nombre del archivo de origen.', trim: true)
        string (name: 'DESTINATION_FILE', defaultValue: '/home/jenkins/myfile.7z', description: 'El nombre del archivo comprimido.', trim: true)
        string (name: 'CPU_CORES', defaultValue: '2', description: 'El número de nucleos de CPU que se usaran para el proceso de compresión.', trim: true)
        choice (name: 'COMPRESS_TYPE', choices: ['Fastest', 'Fast', 'Normal', 'Maximum', 'Ultra'], description: 'Selecciona el nivel de compresión deseado.')
    }

    stages {
        stage('Clean WorkSpace'){
            steps {
                cleanWs()
            }
        }

        stage('DEBUG -> Base64 Encoded'){
            steps {
                println "PARAMETERS_IN_BASE64: " + "$PARAMETERS_IN_BASE64"
                println "ORIGIN_FILE: " + "$ORIGIN_FILE"
                println "DESTINATION_FILE: " + "$DESTINATION_FILE"
                println "CPU_CORES: " + "$CPU_CORES"
                println "COMPRESS_TYPE: " + "$COMPRESS_TYPE"
            }
        }

        stage('Decode from Base64'){
            steps {
                script {
                    if("$PARAMETERS_IN_BASE64" == 'Yes'){
                        decodeOriginFile = KnowMadMoodEJB.decodeBase64("$ORIGIN_FILE")
                        decodeDestinationFile = KnowMadMoodEJB.decodeBase64("$DESTINATION_FILE")
                        decodeCpuCores = KnowMadMoodEJB.decodeBase64("$CPU_CORES")
                        decodeCompressType = KnowMadMoodEJB.decodeBase64("$COMPRESS_TYPE")
                    }else {
                        decodeOriginFile = "$ORIGIN_FILE"
                        decodeDestinationFile = "$DESTINATION_FILE"
                        decodeCpuCores = "$CPU_CORES"
                        decodeCompressType = "$COMPRESS_TYPE"
                    }
                }
            }
        }

        stage('DEBUG -> Base64 Decoded'){
            steps {
                println "PARAMETERS_IN_BASE64: " + "$PARAMETERS_IN_BASE64"
                println "ORIGIN_FILE: " + decodeOriginFile
                println "DESTINATION_FILE: " + decodeDestinationFile
                println "CPU_CORES: " + decodeCpuCores
                println "COMPRESS_TYPE: " + decodeCompressType
            }
        }
    }

    post {
        always {
            chuckNorris()
        }
    }
    
}

/*
7za a -r 
-mmt2 
/home/jenkins/projects/development-pipeline/knowmadmood-jenkins-marzo-2024/fran-gait-zip-file/Jenkinsfile.7z 
/home/jenkins/projects/development-pipeline/knowmadmood-jenkins-marzo-2024/fran-gait-zip-file/Jenkinsfile 
-mx9 

localhost:8081/job/fran-gait-zip-file/buildWithParameters?PARAMETERS_IN_BASE64=Yes&ORIGIN_FILE=cHJ1ZWJh&
DESTINATION_FILE=cHJ1ZWJh&CPU_CORES=cHJ1ZWJh&COMPRESS_TYPE=VWx0cmE=

curl -s -o /dev/null -w "%{http_code}" http://www.example.org/

CRUMB=$(curl -s 'http://localhost:8081/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,":",//crumb)')    
curl --user admin:admin \
    -X POST localhost:8081/job/fran-gait-zip-file/buildWithParameters?token=mySecretPassword \
    -H "$CRUMB" \
    --data-urlencode json='{
    "parameter": [
        {"name":"PARAMETERS_IN_BASE64", "value":"Yes"},
        {"name":"ORIGIN_FILE", "value":"cHJ1ZWJh"},
        {"name":"DESTINATION_FILE", "value":"cHJ1ZWJh"},
        {"name":"CPU_CORES", "value":"cHJ1ZWJh"},
        {"name":"COMPRESS_TYPE", "value":"VWx0cmE"}
    ]
}'

curl -X POST http://tu-servidor-jenkins/job/tu-job/build \
  -H "Authorization: Basic (YWRtaW4=:YWRtaW4=) \
  --data-urlencode json='{
    "parameter": [
        {"name":"PARAMETRO_1", "value":"VALOR_1"},
        {"name":"PARAMETRO_2", "value":"VALOR_2"}
    ]
}'

CRUMB=$(curl -s 'http://localhost:8081/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,":",//crumb)')
curl --user admin:admin -X POST 'localhost:8081/job/fran-gait-zip-file/buildWithParameters?token=mySecretPassword' -H "Jenkins-Crumb:7db09339e731a824bd3ede511ebf26a533dedf399c53039528d2458f856202e9"



11c3f15b81c6428018c6172d3e04b22fd7

curl --user admin:11c3f15b81c6428018c6172d3e04b22fd7 -X POST http://localhost:8081/job/fran-gait-zip-file/buildWithParameters?token=mySecretPassword&PARAMETERS_IN_BASE64=Yes&ORIGIN_FILE=cHJ1ZWJh&DESTINATION_FILE=cHJ1ZWJh&CPU_CORES=cHJ1ZWJh&COMPRESS_TYPE=VWx0cmE=
*/
